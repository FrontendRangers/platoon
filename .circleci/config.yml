# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2

defaults: &defaults
    working_directory: ~/repo
    docker:
        - image: circleci/node:latest-browsers

jobs:
    install:
        <<: *defaults
        steps:
            - checkout
            - restore_cache:
                  key: dependency-cache-{{ checksum "yarn.lock" }}
            - run:
                  name: Install
                  command: yarn install
            - run:
                  name: Bootstrap
                  command: yarn run bootstrap
            - save_cache:
                  key: dependency-cache-{{ checksum "yarn.lock" }}
                  paths:
                      - ./node_modules
            - persist_to_workspace:
                  root: ~/repo
                  paths: .
    build:
        <<: *defaults
        steps:
            - attach_workspace:
                  at: ~/repo
            - run:
                  name: Build
                  command: yarn run build
    release:
        <<: *defaults
        steps:
            - attach_workspace:
                  at: ~/repo
            - run:
                  name: Release
                  command: yarn run release

workflows:
    version: 2
    build_and_release:
        jobs:
            - install:
                  filters:
                      tags:
                          only: /.*/
            - build:
                  requires:
                      - install
                  filters:
                      tags:
                          only: /.*/
            - release:
                  requires:
                      - build
                  filters:
                      branches:
                          only:
                              - master
